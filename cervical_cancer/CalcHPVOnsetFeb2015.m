function [HPVonsetRate] = CalcHPVOnsetFeb2015(InSituOnset, AgeArrayLower,AgeArrayUpper,PAR)

distHPV = PAR{10};
transientReg = [0 0];%[0.405456733  0.388383459];

% % Columns: HPV to CIN1; CIN1 to CIN 2; CIN 2 to CIN 3; CIN 3 to CIS
 ProgRates= [[0.098715973	0.14618251	0.15082289		0.562118918];	%HPV 16/18
     [0.056798949	0.092087877	0.092087877		0.021918655]]; % low risk HPV
% 
% % Columns: HPV to Normal; CIN 1 to HPV; CIN 2 to CIN 1;  CIN 3 to CIN 2;
 RegressRates= [[0.269349807	0.4	0.142716302	0.030459207];	%HPV 16/18
     [0.269349807 0.4 0.142716302	0.030459207]]; % low risk HPV

AgeHPVprev = PAR{11};
HPVprev = PAR{12};

% ProgRates=[
%     %HPV to LSIL
%     [0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0.085304841	0.085304841	0.085304841	0.085304841	0.085304841	0.085304841	0.085304841	0.085304841	0.085304841	0.085304841	0.085304841	0.085304841	0.085304841	0.085304841	0.085304841	0.085304841	0.085304841	0.085304841	0.085304841	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164	0.081023164
%     ]%LSIL to HSIL
%     [0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0.193698765	0.193698765	0.193698765	0.193698765	0.193698765	0.193698765	0.193698765	0.193698765	0.193698765	0.193698765	0.193698765	0.193698765	0.193698765	0.193698765	0.193698765	0.193698765	0.193698765	0.193698765	0.193698765	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583	0.182999583
%     ]%HSIL to CIS
%     [0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0.027697905	0.027697905	0.027697905	0.027697905	0.027697905	0.027697905	0.027697905	0.027697905	0.027697905	0.027697905	0.027697905	0.027697905	0.027697905	0.027697905	0.048139835	0.048139835	0.048139835	0.048139835	0.048139835	0.046333504	0.046333504	0.046333504	0.046333504	0.046333504	0.121212908	0.121212908	0.121212908	0.121212908	0.121212908	0.121212908	0.121212908	0.121212908	0.121212908	0.121212908	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129	0.177501129
%     ]];
%
% RegressRates =[
%      %HPV to DF
%     [0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0.26865464	0.26865464	0.26865464	0.26865464	0.26865464	0.26865464	0.26865464	0.26865464	0.26865464	0.26865464	0.26865464	0.26865464	0.26865464	0.26865464	0.26865464	0.26865464	0.26865464	0.26865464	0.26865464	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248	0.268587248
%     ]%LSIL to HPV
%     [0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0.233874499	0.233874499	0.233874499	0.233874499	0.233874499	0.233874499	0.233874499	0.233874499	0.233874499	0.233874499	0.233874499	0.233874499	0.233874499	0.233874499	0.233874499	0.233874499	0.233874499	0.233874499	0.233874499	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568	0.231553568
%     ]%HSIL to LSIL
%     [0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0.041560922	0.041560922	0.041560922	0.041560922	0.041560922	0.041560922	0.041560922	0.041560922	0.041560922	0.041560922	0.041560922	0.041560922	0.041560922	0.041560922	0.041560922	0.041560922	0.041560922	0.041560922	0.041560922	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603	0.046821603
%     ]];

beta0 = zeros(1,size(AgeArrayLower,2)+1);
LB =zeros(1,size(AgeArrayLower,2)+1);
UB = ones(1,size(AgeArrayLower,2)+1);
LB(end) = 0;
UB(end) = 0.00001;%the last item is immunity from HPV it goes from 10 years to lifelong
% beta0 = [0 0 0];
% LB =[0 0 0];
% UB = [1 1 1];
X =[0:100]';

%OPTIONS = optimset('largescale','off','LevenbergMarquardt','on','display','off','Diagnostics','on','MaxFunEvals',700,'TolFun',1e-8,'TolCon',1e-8);
OPTIONS = optimset('MaxFunEvals',2000,'Diagnostics','on','TolFun',1e-6,'TolCon',1e-6);
%Y=[InSituOnset*1000, HPVprev]' ;
Y=[InSituOnset*1000]' ;
%FitArray = [InSituOnset*1000, HPVprev]' ;
FitArray = [InSituOnset*1000]' ;
[beta,resnorm,residual,exitflag,output,lambda,jacobian] = lsqcurvefit(@(x,X)...
    PopSim(x,X,FitArray, ProgRates, RegressRates,AgeArrayLower,AgeArrayUpper,PAR, 0, distHPV, transientReg),...
    beta0,X,Y,LB,UB,OPTIONS);



%plot the results
[InsituOnsetRate, HPVonsetRate]=PopSim(beta,X,FitArray,ProgRates, RegressRates,AgeArrayLower,AgeArrayUpper,PAR,1,distHPV, transientReg);


end

function [Result,HPVonsetRate ] = PopSim(beta,X,InSituOnset, ProgRates, RegressRates,AgeArrayLower,AgeArrayUpper,PAR,plotInd, distHPV, transientReg)

%r1=beta * distHPV(1);
r2=0.0931; %Highrisk HPV to LSIL
r3=0.2107; %LSIL to HSIL
r4=0.1188; %LSIL to Highrisk HPV
r5=0.01715; %HSIL to Highrisk HPV
r6=0.01715; %HSIL to Normal
r7=0.1188; %LSIL to Normal
%r8=beta * distHPV(2); 
r9=0.0568; %Lowrisk HPV to LSIL
r10=0.0921; %LSIL to HSIL
r11=0.0704; %HSIL to Lowrisk HPV
r12=0.1059; %LSIL to Lowrisk HPV
r13=0.0704; %HSIL to Normal
r14=0.1059; %LSIL to Normal
r17=0.2693; %HighRisk HPV to Normal
r18=0.2682; %LowRisk HPV to Normal


probAgeA=PAR{1};probAgeA(81:end)=probAgeA(81)/length(probAgeA(81:end));
mu=PAR{2}';mu(81:end)=mu(80)+1/5;
BirthsF=PAR{3};%female pop only

AgeHPVprev = PAR{11};
HPVprev = PAR{12};

agemax=101;
m_a=length(probAgeA);
%age,state, duration of disease
pop0=100000;%work with pop of standard size

Stages = 9 ;
POP=zeros(m_a,Stages);
POP(1:m_a,1)=probAgeA*pop0;

r15=zeros(size(POP,1),size(POP,1));%HSIL of Highrisk HPV to CIS, varied by ages
for i=1:30
    r15(i,i)=0.0292;
end
for i=31:39
    r15(i,i)=0.0506;
end
for i=40:49
    r15(i,i)=0.1344;
end
for i=50:size(POP,1)
    r15(i,i)=0.1952;
end

r16=zeros(size(POP,1),size(POP,1));%HSIL of Lowrisk HPV to CIS, varied by ages
for i=1:30
    r16(i,i)=0.0070;
end
for i=31:39
    r16(i,i)=0.0140;
end
for i=40:49
    r16(i,i)=0.0221;
end
for i=50:size(POP,1)
    r16(i,i)=0.0445;
end


t_max=500;
CFR = zeros(m_a,t_max);

% AgeArrayMid=((AgeArrayUpper+AgeArrayLower)/2);
% HPVonsetRate = interp1(AgeArrayMid,beta,[0:100],'cubic');
for J = 1:size(AgeArrayLower,2)
    Ind = (AgeArrayLower(J)+1):(AgeArrayUpper(J)+1);
    HPVonsetRate(Ind)=beta(J);
end
HPVonsetRate(1,1:15)= 0;

%r1 = eye(size(POP,1)).*HPVonsetRate * distHPV(1); %Normal to Highrisk HPV, to be calculated
%r8 = eye(size(POP,1)).*HPVonsetRate * distHPV(2);%Normal to Lowrisk HPV, to be calculated
r1 = HPVonsetRate * distHPV(1); %Normal to Highrisk HPV, to be calculated
r8 = HPVonsetRate * distHPV(2);%Normal to Lowrisk HPV, to be calculated
Immunity = 10;%beta(end);
r19=1./Immunity; %Immunity to Normal

dt=1/12;
for t=1:t_max
    
%      propTransientHPV = [0 0];%[4.4 1.06];
%     % Including transient HPV
%     HPVonsetRateAll = HPVonsetRate*propTransientHPV(1);
%     HPVonsetRateAll(1,36:end) = HPVonsetRate(1,36:end)*propTransientHPV(2);
   
    %fast time loop
    value = zeros(101,1);
    for t1=1:1/dt
        POP(:,1)=POP(:,1) + (-mu.*POP(:,1) -r1'.*POP(:,1) - r8'.*POP(:,1) +r19.*POP(:,9))*dt;
        
        POP(:,9)=POP(:,9) + (-mu.*POP(:,9) -r19.*POP(:,9) + r17.*POP(:,2) + r7.*POP(:,3) + r6.*POP(:,4) + r18.*POP(:,5) + r14.*POP(:,6) + r13.*POP(:,7))*dt;
        
        POP(:,2)=POP(:,2) + (-mu.*POP(:,2) -r2.*POP(:,2) -r17.*POP(:,2) + r1'.*POP(:,1) + r4.*POP(:,3) + r5.*POP(:,4))*dt;
        POP(:,3)=POP(:,3) + (-mu.*POP(:,3) -r7.*POP(:,3) - r4.*POP(:,3) - r3.*POP(:,3) + r2.*POP(:,2))*dt;
        POP(:,4)=POP(:,4) + (-mu.*POP(:,4) -r5.*POP(:,4) - r6.*POP(:,4) - r15*POP(:,4) + r3.*POP(:,3))*dt; 

        POP(:,5)=POP(:,5) + (-mu.*POP(:,5) -r9.*POP(:,5) - r18.*POP(:,5) + r8'.*POP(:,1) + r12.*POP(:,6) + r11.*POP(:,7))*dt;
        POP(:,6)=POP(:,6) + (-mu.*POP(:,6) -r14.*POP(:,6) - r10.*POP(:,6) - r12.*POP(:,6) + r9.*POP(:,5))*dt;
        POP(:,7)=POP(:,7) + (-mu.*POP(:,7) -r13.*POP(:,7) - r11.*POP(:,7) - r16*POP(:,7) + r10.*POP(:,6))*dt; 

        POP(:,8)=POP(:,8) + (-mu.*POP(:,8) +r15*POP(:,4) + r16*POP(:,7))*dt;

        value=value + (r15*POP(:,4) + r16*POP(:,7))*dt; 

    end
    
    InsituOnsetRate(1,:) =1000*value ./ sum(POP,2);
    
    %valueN = sum(sum(POP));
    %aging
    %lAge=POP(end,1)+POP(end,2)+POP(end,3)+POP(end,4);
    for I=1:Stages
        POP(2:end,I)=POP(1:end-1,I);
    end
    %POP(end,4) = POP(end,4) +lAge;
    %must decide if births are to be based on population size
    Births=probAgeA(1,1)* sum(sum(POP));%42;%InsituOnsetRate.*probAgeA' *pop0;%BirthsF*sum(POP(:));
    POP(1,1)=Births;
    
    PrevalenceHPVByAge(1,:) =  ((POP(:,2)+POP(:,5))./sum(POP,2));
    HPVageDist= zeros(1,size(AgeHPVprev,2));
    for J = 1:size(AgeHPVprev,2)
    Ind = AgeHPVprev(1,J):AgeHPVprev(2,J);
    HPVageDist(J)=(sum(PrevalenceHPVByAge(1,Ind).*probAgeA(1,Ind)))/sum(probAgeA(1,Ind));
    
    end
    %Result = [InsituOnsetRate(1,:), HPVageDist *10]';
    Result = [InsituOnsetRate(1,:)]';
end

if plotInd==1
%     propTransientHPV = [0.185111634	0.185111634	0.185111634	0.185111634	0.185111634	0.185111634	0.185111634	0.185111634	0.185111634	0.185111634	0.185111634	0.185111634	0.185111634	0.185111634	0.185111634	0.185111634	0.185111634	0.185111634	0.185111634	0.185111634	0.185111634	0.185111634	0.185111634	0.185111634	0.185111634	0.185111634	0.185111634	0.185111634	0.185111634	0.185111634	0.185111634	0.185111634	0.185111634	0.185111634	0.185111634	0.185111634	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028	0.483781028
%         ];
%     
%     HPVonsetRateAll = HPVonsetRate./propTransientHPV;
%     TransientPOP=zeros(m_a,4);
%     TransientPOP(1:m_a,1)=probAgeA*pop0;
%     
%     %Simulate transient HPV
%     for t=1:t_max
%         %fast time loop
%         for t1=1:15
%             TransientPOP(:,4) = TransientPOP(:,4) + dt*( transientReg(1,2)).*TransientPOP(:,3) - dt *(mu + transientReg(1,1)).*TransientPOP(:,4);
%             TransientPOP(:,3) = TransientPOP(:,3) + dt* (ProgRates(2,1)).*TransientPOP(:,2) - dt*(mu + transientReg(1,2)).*TransientPOP(:,3);
%             TransientPOP(:,2) = TransientPOP(:,2) +  dt*(HPVonsetRateAll').*TransientPOP(:,1) - dt*(mu + ProgRates(2,1) + transientReg(1,1)).*TransientPOP(:,2);
%             TransientPOP(:,1) = TransientPOP(:,1)- dt*(mu + HPVonsetRateAll').*TransientPOP(:,1) + dt*( transientReg(1,1)).*TransientPOP(:,2) + dt *( transientReg(1,1)).*TransientPOP(:,4);
%             
%         end
%     end
    
    %PrevalenceHPV = sum((((POP(:,2)+POP(:,10)+POP(:,6))./sum(POP,2))./propTransientHPV').*probAgeA')
    PrevalenceHPVByAge = ((POP(:,2)+POP(:,5))./sum(POP,2));
    PrevalenceHPV = sum(PrevalenceHPVByAge (18:70,1).*probAgeA(1,18:70)')/sum(probAgeA(1,18:70))
    
    
    fid = fopen('data.xls','a');
    fprintf(fid,'%6.2f \t',PrevalenceHPVByAge);
    fprintf(fid,'\n');
    fprintf(fid,'%6.2f \n',PrevalenceHPV);
     fprintf(fid,'%6.2f \t',HPVonsetRate);
    fprintf(fid,'\n');
     fprintf(fid,'%6.2f \t',InSituOnset);
    fprintf(fid,'\n');
    fprintf(fid,'%6.2f \t',Result);
    fprintf(fid,'\n');
    fclose(fid);
    
    
    
    close all
    figure
    hold on
    plot(0:100, PrevalenceHPVByAge(:,1),'r');
    title('HPV prevalence rates');
    
    figure
    hold on
    plot(0:100, HPVonsetRate(1,:),'r');
    title('HPV onset rates');
    
    figure
    hold on
    plot(0:100, Result,'r');
    plot(0:100, InSituOnset,'r*');
    title('Insitu rates');
 %   pause
end

end